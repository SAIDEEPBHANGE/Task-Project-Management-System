// --- Enums ---
Enum OrganizationRole { Owner; Admin; Member }
Enum ProjectRole { Owner; Admin; Member; Viewer }
Enum TaskStatus { Todo; InProgress; Done; Archived }
Enum TaskPriority { Low; Medium; High }

// --- Core Identity ---
Table Users {
  Id int [pk, increment]
  FullName varchar [not null]
  Username varchar [not null, unique]
  Email varchar [not null, unique]
  PasswordHash varchar [not null]
  AvatarUrl varchar
  LastLoginAt timestamp // NEW: Useful for security/cleanup
  CreatedAt timestamp [default: `now()`]
  UpdatedAt timestamp
  DeletedAt timestamp
}

// --- Multi-Tenant Layer ---
Table Organizations {
  Id int [pk, increment]
  Name varchar [not null]
  Slug varchar [unique, not null]
  OwnerId int [not null, ref: > Users.Id] // Consistent naming
  CreatedAt timestamp [default: `now()`]
  UpdatedAt timestamp
  DeletedAt timestamp
}

Table OrganizationMembers {
  Id int [pk, increment]
  OrganizationId int [not null, ref: > Organizations.Id]
  UserId int [not null, ref: > Users.Id]
  Role OrganizationRole [default: 'Member']
  JoinedAt timestamp [default: `now()`]
  
  Indexes {
    (OrganizationId, UserId) [unique]
  }
}

// --- Project Layer ---
Table Projects {
  Id int [pk, increment]
  OrganizationId int [not null, ref: > Organizations.Id]
  Title varchar [not null]
  Description text
  CreatedBy int [not null, ref: > Users.Id]
  CreatedAt timestamp [default: `now()`]
  UpdatedAt timestamp
  DeletedAt timestamp
  
  Indexes {
    OrganizationId // NEW: Crucial for multi-tenant query performance
  }
}

Table ProjectMembers {
  Id int [pk, increment]
  ProjectId int [not null, ref: > Projects.Id]
  UserId int [not null, ref: > Users.Id]
  Role ProjectRole [default: 'Member']
  JoinedAt timestamp [default: `now()`]

  Indexes {
    (ProjectId, UserId) [unique]
  }
}

// --- Work Layer ---
Table Tasks {
  Id int [pk, increment]
  ProjectId int [not null, ref: > Projects.Id]
  OrganizationId int [not null, ref: > Organizations.Id] // NEW: Denormalized for security/speed
  Title varchar [not null]
  Description text
  Status TaskStatus [default: 'Todo']
  Priority TaskPriority [default: 'Medium']
  CreatedBy int [not null, ref: > Users.Id]
  AssignedTo int [ref: > Users.Id]
  DueDate datetime
  CreatedAt timestamp [default: `now()`]
  UpdatedAt timestamp
  DeletedAt timestamp

  Indexes {
    ProjectId
    OrganizationId // Filter by Org
    AssignedTo
    (Status, Priority) // Complex filtering for dashboards
  }
}

Table Comments {
  Id int [pk, increment]
  TaskId int [not null, ref: > Tasks.Id]
  UserId int [not null, ref: > Users.Id]
  ParentCommentId int [ref: > Comments.Id] // NEW: Threading support
  Content text [not null]
  CreatedAt timestamp [default: `now()`]
  UpdatedAt timestamp
  DeletedAt timestamp
}